<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IDEAL CORE | –ö–∞–±–∏–Ω–µ—Ç</title>
    <style>
        :root { --bg: #0f0f1a; --card: #1a1a2e; --text: #e0e0e0; --accent: #00d9ff; --success: #00ff88; --danger: #ff4444; }
        body { font-family: monospace; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #333; margin-bottom: 20px; }
        .logout { background: var(--danger); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
        .form-card, .list-card { background: var(--card); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #333; }
        input, select, button { width: 100%; padding: 10px; margin: 5px 0; background: #0f0f1a; border: 1px solid #333; color: var(--text); border-radius: 4px; box-sizing: border-box; }
        button { background: var(--accent); color: #000; font-weight: bold; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #333; }
        th { color: var(--accent); }
        .status-active { color: var(--success); }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üóùÔ∏è –õ–∏—á–Ω—ã–π –ö–∞–±–∏–Ω–µ—Ç</h1>
            <div>
                <span id="userName">...</span>
                <span id="userSum">Œ£=--</span>
                <button class="logout" onclick="logout()">–í—ã–π—Ç–∏</button>
            </div>
        </header>
        <div class="form-card">
            <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å –ß–µ–ª–æ–≤–µ–∫–∞</h2>
            <input type="text" id="personName" placeholder="–ò–º—è">
            <input type="date" id="personBirth">
            <select id="personRelation">
                <option value="Partner">–ü–∞—Ä—Ç–Ω—ë—Ä</option>
                <option value="Family">–°–µ–º—å—è</option>
                <option value="Client">–ö–ª–∏–µ–Ω—Ç</option>
                <option value="Other">–î—Ä—É–≥–æ–µ</option>
            </select>
            <button onclick="addPerson()">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <div class="list-card">
            <h2>üìã –õ—é–¥–∏</h2>
            <table>
                <thead><tr><th>–ò–º—è</th><th>–î–∞—Ç–∞</th><th>Œ£</th><th>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</th><th>–°—Ç–∞—Ç—É—Å</th></tr></thead>
                <tbody id="peopleTable"></tbody>
            </table>
        </div>
    </div>
    <script>
        const API = '/api';
        let token = localStorage.getItem('ideal_token');
        let user = JSON.parse(localStorage.getItem('ideal_user') || '{}');
        if (!token) window.location.href = '/login.html';
        document.getElementById('userName').textContent = user.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        if (user.birth_date) {
            const d = new Date(user.birth_date);
            const sum = calcSum(d.getDate()) + calcSum(d.getMonth()+1) + calcSum(d.getFullYear() % 1000);
            document.getElementById('userSum').textContent = 'Œ£=' + sum;
        }
        async function loadPeople() {
            const res = await fetch(API + '/people', { headers: { 'Authorization': token } });
            if (res.status === 401) { logout(); return; }
            const people = await res.json();
            const tbody = document.getElementById('peopleTable');
            tbody.innerHTML = '';
            people.forEach(p => {
                tbody.innerHTML += `<tr><td>${p.name}</td><td>${p.birth_date}</td><td>${p.sum_freq}</td><td>${p.coords}</td><td class="status-active">${p.flow_status}</td></tr>`;
            });
        }
        async function addPerson() {
            const name = document.getElementById('personName').value;
            const birth = document.getElementById('personBirth').value;
            const relation = document.getElementById('personRelation').value;
            if (!name || !birth) { alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è –∏ –¥–∞—Ç—É'); return; }
            const res = await fetch(API + '/people/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': token },
                body: JSON.stringify({ name, birth_date: birth, relation })
            });
            if (res.ok) { document.getElementById('personName').value = ''; loadPeople(); }
            else { alert('–û—à–∏–±–∫–∞: ' + await res.text()); }
        }
        function logout() {
            localStorage.removeItem('ideal_token');
            localStorage.removeItem('ideal_user');
            window.location.href = '/login.html';
        }
        function calcSum(n) { let s = 0; while (n > 0) { s += n % 10; n = Math.floor(n / 10); } return s; }
        loadPeople();
    </script>
</body>
</html>
