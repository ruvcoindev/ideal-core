<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>IDEAL CORE | –î–Ω–µ–≤–Ω–∏–∫</title>
    <style>
        :root { --bg: #0f0f1a; --card: #1a1a2e; --text: #e0e0e0; --accent: #00d9ff; --gratitude: #ffd700; }
        body { font-family: monospace; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .card { background: var(--card); padding: 20px; border-radius: 8px; margin: 20px 0; }
        .mode-toggle { display: flex; gap: 10px; margin-bottom: 20px; }
        .mode-btn { flex: 1; padding: 15px; border: 2px solid #333; background: #2a2a3e; color: var(--text); cursor: pointer; border-radius: 8px; transition: all 0.2s; }
        .mode-btn.active { border-color: var(--accent); background: #3a3a5e; }
        .mode-btn.gratitude.active { border-color: var(--gratitude); }
        .gratitude-item { display: flex; gap: 10px; margin: 10px 0; align-items: center; }
        .gratitude-item input { flex: 1; }
        .specificity-slider { width: 100px; }
        input, textarea, select { width: 100%; padding: 10px; margin: 5px 0; background: #0f0f1a; border: 1px solid #333; color: var(--text); border-radius: 4px; }
        button { background: var(--accent); color: #000; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button.gratitude { background: var(--gratitude); color: #000; }
        .entry { border-left: 3px solid var(--accent); padding-left: 15px; margin: 15px 0; }
        .entry.gratitude { border-left-color: var(--gratitude); }
        .tag { display: inline-block; background: #333; padding: 2px 8px; border-radius: 4px; margin: 2px; font-size: 0.9em; }
        .tag.gratitude { background: var(--gratitude); color: #000; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        .stat-box { background: #2a2a3e; padding: 15px; border-radius: 8px; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìì –î–Ω–µ–≤–Ω–∏–∫</h1>
        
        <!-- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤ -->
        <div class="mode-toggle">
            <button class="mode-btn active" onclick="setMode('cbt')">üß† –ö–ü–¢ (—Ä–∞–±–æ—Ç–∞ —Å –º—ã—Å–ª—è–º–∏)</button>
            <button class="mode-btn gratitude" onclick="setMode('gratitude')">üíõ –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å</button>
        </div>
        
        <!-- –§–æ—Ä–º–∞ –ö–ü–¢ -->
        <div id="cbtForm" class="card">
            <h2>‚úçÔ∏è –ó–∞–ø–∏—Å—å –ö–ü–¢</h2>
            <textarea id="situation" placeholder="–ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ? (–æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ)"></textarea>
            <textarea id="automaticThought" placeholder="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º—ã—Å–ª—å"></textarea>
            <input type="text" id="emotions" placeholder="–≠–º–æ—Ü–∏–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)">
            <input type="number" id="intensity" min="0" max="100" value="50" placeholder="–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å 0-100">
            <button onclick="saveCBTEntry()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button type="button" onclick="showRational()">üß† –ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç</button>
            <div id="rationalResponse" style="margin-top:10px;padding:10px;background:#2a2a3e;border-radius:4px;display:none;"></div>
        </div>
        
        <!-- –§–æ—Ä–º–∞ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ -->
        <div id="gratitudeForm" class="card" style="display:none;">
            <h2>üíõ –î–Ω–µ–≤–Ω–∏–∫ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏</h2>
            <p><small>–ó–∞–ø–∏—à–∏—Ç–µ 3-5 –ø—É–Ω–∫—Ç–æ–≤, –Ω–∞—á–∏–Ω–∞—è —Å ¬´–Ø –±–ª–∞–≥–æ–¥–∞—Ä–µ–Ω –∑–∞...¬ª. –ë—É–¥—å—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã.</small></p>
            <div id="gratitudeItems"></div>
            <button type="button" onclick="addGratitudeItem()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—É–Ω–∫—Ç</button>
            <textarea id="gratitudeNotes" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
            <button class="gratitude" onclick="saveGratitudeEntry()">üíõ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å</button>
        </div>
        
        <!-- –ü–æ–∏—Å–∫ -->
        <div class="card">
            <h2>üîç –ü–æ–∏—Å–∫ –ø–æ —Å–º—ã—Å–ª—É</h2>
            <input type="text" id="searchQuery" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: '—Ñ–∏–Ω–∞–Ω—Å—ã', '–±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å', '–≥—Ä–∞–Ω–∏—Ü—ã'...">
            <button onclick="searchEntries()">üîç –ù–∞–π—Ç–∏</button>
            <label><input type="checkbox" id="searchGratitude" checked> –í–∫–ª—é—á–∞—è –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å</label>
        </div>
        
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="card">
            <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
            <div class="stats-grid" id="statsContainer">
                <div class="stat-box"><h3 id="totalEntries">0</h3><p>–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</p></div>
                <div class="stat-box"><h3 id="cbtCount">0</h3><p>–ö–ü–¢</p></div>
                <div class="stat-box"><h3 id="gratitudeCount">0</h3><p>–ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å</p></div>
                <div class="stat-box"><h3 id="gratitudeRatio">0%</h3><p>–î–æ–ª—è –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏</p></div>
            </div>
        </div>
        
        <!-- –°–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π -->
        <div class="card">
            <h2>üìã –ó–∞–ø–∏—Å–∏</h2>
            <div id="entriesList"></div>
        </div>
    </div>

    <script>
        let currentMode = 'cbt';
        
        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('cbtForm').style.display = mode === 'cbt' ? 'block' : 'none';
            document.getElementById('gratitudeForm').style.display = mode === 'gratitude' ? 'block' : 'none';
            if (mode === 'gratitude' && document.getElementById('gratitudeItems').children.length === 0) {
                addGratitudeItem(); addGratitudeItem(); addGratitudeItem(); // 3 –ø—É–Ω–∫—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            }
        }
        
        function addGratitudeItem() {
            const container = document.getElementById('gratitudeItems');
            const div = document.createElement('div');
            div.className = 'gratitude-item';
            div.innerHTML = `
                <input type="text" class="gratitude-text" placeholder="–Ø –±–ª–∞–≥–æ–¥–∞—Ä–µ–Ω –∑–∞...">
                <select class="gratitude-category">
                    <option value="small_things">–ú–µ–ª–æ—á–∏</option>
                    <option value="people">–õ—é–¥–∏</option>
                    <option value="nature">–ü—Ä–∏—Ä–æ–¥–∞</option>
                    <option value="self">–°–µ–±–µ</option>
                    <option value="growth">–†–æ—Å—Ç</option>
                </select>
                <input type="range" class="specificity-slider" min="1" max="10" value="7" title="–ö–æ–Ω–∫—Ä–µ—Ç–∏–∫–∞ 1-10">
                <span class="specificity-value">7</span>
            `;
            container.appendChild(div);
            div.querySelector('.specificity-slider').oninput = (e) => {
                e.target.nextElementSibling.textContent = e.target.value;
            };
        }
        
        async function saveCBTEntry() {
            const entry = {
                type: 'cbt',
                situation: document.getElementById('situation').value,
                automatic_thought: document.getElementById('automaticThought').value,
                emotions: document.getElementById('emotions').value.split(',').map(s => s.trim()),
                intensity: parseInt(document.getElementById('intensity').value),
                timestamp: new Date().toISOString()
            };
            await fetch('/api/journal/entries', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(entry)
            });
            loadStats(); loadEntries();
            document.getElementById('situation').value = '';
            document.getElementById('automaticThought').value = '';
        }
        
        async function saveGratitudeEntry() {
            const items = [];
            document.querySelectorAll('.gratitude-item').forEach(div => {
                items.push({
                    text: div.querySelector('.gratitude-text').value,
                    category: div.querySelector('.gratitude-category').value,
                    specificity: parseInt(div.querySelector('.specificity-slider').value),
                    emotion: 'gratitude'
                });
            });
            const entry = {
                type: 'gratitude',
                gratitude_items: items.filter(i => i.text.trim()),
                notes: document.getElementById('gratitudeNotes').value,
                timestamp: new Date().toISOString()
            };
            await fetch('/api/journal/entries', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(entry)
            });
            loadStats(); loadEntries();
        }
        
        async function loadStats() {
            const res = await fetch('/api/journal/stats');
            const stats = await res.json();
            document.getElementById('totalEntries').textContent = stats.total_entries;
            document.getElementById('cbtCount').textContent = stats.cbt_entries || 0;
            document.getElementById('gratitudeCount').textContent = stats.gratitude_entries || 0;
            document.getElementById('gratitudeRatio').textContent = Math.round((stats.gratitude_ratio || 0) * 100) + '%';
        }
        
        async function loadEntries() {
            const res = await fetch('/api/journal/entries');
            const entries = await res.json();
            document.getElementById('entriesList').innerHTML = entries.map(e => `
                <div class="entry ${e.type === 'gratitude' ? 'gratitude' : ''}">
                    <small>${new Date(e.timestamp).toLocaleString('ru-RU')}</small>
                    <strong>${e.type === 'gratitude' ? 'üíõ –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å' : 'üß† –ö–ü–¢'}</strong>
                    ${e.phase ? `| –§–∞–∑–∞: ${e.phase}` : ''}
                    ${e.person_id ? `| ${e.person_id}` : ''}
                    <p>${e.type === 'gratitude' ? e.gratitude_items.map(i => `‚Ä¢ ${i.text}`).join('<br>') : `<strong>–°–∏—Ç—É–∞—Ü–∏—è:</strong> ${e.situation}<br><strong>–ú—ã—Å–ª—å:</strong> ${e.automatic_thought}`}</p>
                    ${e.distortions?.length ? `<p><strong>–ò—Å–∫–∞–∂–µ–Ω–∏—è:</strong> ${e.distortions.join(', ')}</p>` : ''}
                    ${e.rational_response ? `<p><strong>–û—Ç–≤–µ—Ç:</strong> ${e.rational_response}</p>` : ''}
                    ${e.gratitude_level ? `<p><strong>–£—Ä–æ–≤–µ–Ω—å:</strong> ${e.gratitude_level}/10</p>` : ''}
                    <p><strong>–¢–µ–≥–∏:</strong> ${e.tags.map(t => `<span class="tag ${t.includes('gratitude')?'gratitude':''}">${t}</span>`).join('')}</p>
                </div>
            `).join('');
        }
        
        async function searchEntries() {
            const query = document.getElementById('searchQuery').value;
            const res = await fetch(`/api/journal/search?q=${encodeURIComponent(query)}`);
            const entries = await res.json();
            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ loadEntries)
            alert(`–ù–∞–π–¥–µ–Ω–æ: ${entries.length} –∑–∞–ø–∏—Å–µ–π`);
        }
        
        function showRational() {
            const thought = document.getElementById('automaticThought').value;
            let response = "–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∑–≥–ª—è–¥: ";
            if (thought.toLowerCase().includes('–≤—Å–µ–≥–¥–∞') || thought.toLowerCase().includes('–Ω–∏–∫–æ–≥–¥–∞')) {
                response += "–ï—Å—Ç—å –ª–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è? ";
            }
            if (thought.toLowerCase().includes('–¥–æ–ª–∂–µ–Ω')) {
                response += "–ß—Ç–æ –µ—Å–ª–∏ –∑–∞–º–µ–Ω–∏—Ç—å ¬´–¥–æ–ª–∂–µ–Ω¬ª –Ω–∞ ¬´–≤—ã–±–∏—Ä–∞—é¬ª? ";
            }
            document.getElementById('rationalResponse').textContent = response;
            document.getElementById('rationalResponse').style.display = 'block';
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        loadStats(); loadEntries();
    </script>
</body>
</html>
